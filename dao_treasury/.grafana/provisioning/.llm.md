# Grafana Dashboard Filter Rules

## Persistent Rule: Filter Query Pattern

- All dashboard filters (templating variables) **must** query the SQLite server for their list of values.
- The SQL for each filter should use a `SELECT DISTINCT ... FROM ...` query, returning only the relevant values.
- When using a filter in a panel's SQL, always use the `${filter:sqlstring}` syntax in the WHERE clause to support multi-select and "All" options.
- This applies to all filters, including but not limited to: Org/Owner, Repo, Author, State, Merged, etc.

**Example:**
```json
{
  "name": "org",
  "type": "query",
  "datasource": "SQLite",
  "query": "SELECT DISTINCT substr(r.full_name, 1, instr(r.full_name, '/')-1) AS org FROM github_repos r ORDER BY org;",
  ...
}
```
And in the panel SQL:
```sql
WHERE substr(r.full_name, 1, instr(r.full_name, '/')-1) IN (${org:sqlstring})
```

**Rationale:**  
This ensures all filter values are always up-to-date with the database, and dashboards remain flexible and user-friendly.

_Last updated: 2025-11-08_

---

## Persistent Rule: Human-Friendly Visual Formatting

- All headers for visuals (panel titles, table column headers) and visual subitems (filter labels, legend items, etc.) **must always be nicely formatted for human users**.
  - Use capitalization and spacing appropriate for natural language.
  - Avoid code-style names (e.g., use "Open PRs" not "open_prs", "Repo" not "repo").
  - Ensure all visible labels are clear, concise, and user-friendly.

**Rationale:**  
This ensures dashboards are readable and approachable for all users, not just developers.

_Last updated: 2025-11-08_

---

## Note for SQLite

- Use SQLite-compatible SQL in all queries (e.g., use `substr(..., 1, instr(..., '/')-1)` instead of Postgres `split_part`).
- The `${filter:sqlstring}` syntax is supported by Grafana for multi-select variables with the frser-sqlite-datasource.
- All other rules apply as written.

# Grafana visual update rules

- When updating a query for a Grafana visual (panel), always check if the legend or any transformations also need to be updated to match the new query output.
- Ensure that any changes to the SELECT or GROUP BY clauses are reflected in the panel's legend and transformation settings, so the visual displays the intended breakdown and grouping.
