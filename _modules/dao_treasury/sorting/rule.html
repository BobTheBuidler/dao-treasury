

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dao_treasury.sorting.rule &mdash; dao-treasury  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            dao-treasury
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wallets.html">Defining Treasury Wallets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sort_rules.html">Defining Sort Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/modules.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transactions.html">Transactions Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to DAO Treasury</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dao-treasury</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dao_treasury.sorting.rule</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dao_treasury.sorting.rule</h1><div class="highlight"><pre>
<span></span><span class="c1"># dao_treasury/sorting/rule.py</span>

<span class="sd">&quot;&quot;&quot;Module defining transaction sorting rules for the DAO treasury.</span>

<span class="sd">This module provides the `_SortRule` base class and subclasses for categorizing</span>
<span class="sd">`TreasuryTx` entries based on their attributes or a custom function. When a rule</span>
<span class="sd">is instantiated, it registers itself in the global `SORT_RULES` mapping under its</span>
<span class="sd">class and configures which transaction attributes to match via `_match_all`.</span>

<span class="sd">Examples:</span>
<span class="sd">    # Define a revenue rule for sales (assuming you only transact in DAI for sales)</span>
<span class="sd">    &gt;&gt;&gt; from dao_treasury.sorting.rule import RevenueSortRule, SORT_RULES</span>
<span class="sd">    &gt;&gt;&gt; RevenueSortRule(</span>
<span class="sd">    ...     txgroup=&#39;Sale&#39;,</span>
<span class="sd">    ...     token_address=&#39;0x6B175474E89094d879c81e570a000000000000&#39;,</span>
<span class="sd">    ...     symbol=&#39;DAI&#39;</span>
<span class="sd">    ... )</span>
<span class="sd">    # Inspect rules registered for RevenueSortRule</span>
<span class="sd">    &gt;&gt;&gt; len(SORT_RULES[RevenueSortRule])</span>
<span class="sd">    1</span>

<span class="sd">    # Iterate over all ExpenseSortRule instances</span>
<span class="sd">    &gt;&gt;&gt; from dao_treasury.sorting.rule import ExpenseSortRule</span>
<span class="sd">    &gt;&gt;&gt; for rule in SORT_RULES[ExpenseSortRule]:</span>
<span class="sd">    ...     print(rule.txgroup)</span>

<span class="sd">See Also:</span>
<span class="sd">    :const:`~dao_treasury.sorting.rule.SORT_RULES`</span>
<span class="sd">    :class:`~dao_treasury.sorting.rule._SortRule`</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">DefaultDict</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Final</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">brownie.convert.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">EthAddress</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eth_typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">HexStr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mypy_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">mypyc_attr</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dao_treasury._wallet</span><span class="w"> </span><span class="kn">import</span> <span class="n">TreasuryWallet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dao_treasury.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">SortFunction</span><span class="p">,</span> <span class="n">SortRule</span><span class="p">,</span> <span class="n">TxGroupDbid</span><span class="p">,</span> <span class="n">TxGroupName</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dao_treasury.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">TreasuryTx</span>


<span class="n">SORT_RULES</span><span class="p">:</span> <span class="n">DefaultDict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">SortRule</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">SortRule</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Mapping from sort rule classes to lists of instantiated rules, in creation order per class.</span>

<span class="sd">Each key is a subclass of :class:`~dao_treasury.types.SortRule` and the corresponding</span>
<span class="sd">value is the list of rule instances of that class.</span>

<span class="sd">Examples:</span>
<span class="sd">    &gt;&gt;&gt; from dao_treasury.sorting.rule import RevenueSortRule, SORT_RULES</span>
<span class="sd">    &gt;&gt;&gt; RevenueSortRule(txgroup=&#39;Interest&#39;, symbol=&#39;DAI&#39;)</span>
<span class="sd">    &gt;&gt;&gt; SORT_RULES[RevenueSortRule][0].txgroup</span>
<span class="sd">    &#39;Revenue:Interest&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">_match_all</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">TxGroupName</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="sd">&quot;&quot;&quot;An internal cache defining which matcher attributes are used for each `txgroup`.&quot;&quot;&quot;</span>

<span class="n">_MATCHING_ATTRS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;hash&quot;</span><span class="p">,</span>
    <span class="s2">&quot;from_address&quot;</span><span class="p">,</span>
    <span class="s2">&quot;from_nickname&quot;</span><span class="p">,</span>
    <span class="s2">&quot;to_address&quot;</span><span class="p">,</span>
    <span class="s2">&quot;to_nickname&quot;</span><span class="p">,</span>
    <span class="s2">&quot;token_address&quot;</span><span class="p">,</span>
    <span class="s2">&quot;symbol&quot;</span><span class="p">,</span>
    <span class="s2">&quot;log_index&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="nd">@mypyc_attr</span><span class="p">(</span><span class="n">native_class</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_SortRule</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for defining transaction matching rules.</span>

<span class="sd">    When instantiated, a rule validates its inputs, determines which transaction</span>
<span class="sd">    attributes to match (or uses a custom function), and registers itself</span>
<span class="sd">    in the global `SORT_RULES` mapping under its class.</span>

<span class="sd">    Matched transactions are assigned to the specified `txgroup`.</span>

<span class="sd">    See Also:</span>
<span class="sd">        :const:`dao_treasury.sorting.rule.SORT_RULES`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">txgroup</span><span class="p">:</span> <span class="n">TxGroupName</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of the transaction group to assign upon match.&quot;&quot;&quot;</span>

    <span class="nb">hash</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HexStr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exact transaction hash to match.&quot;&quot;&quot;</span>

    <span class="n">from_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EthAddress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Source wallet address to match.&quot;&quot;&quot;</span>

    <span class="n">from_nickname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sender nickname (alias) to match.&quot;&quot;&quot;</span>

    <span class="n">to_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EthAddress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recipient wallet address to match.&quot;&quot;&quot;</span>

    <span class="n">to_nickname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recipient nickname (alias) to match.&quot;&quot;&quot;</span>

    <span class="n">token_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EthAddress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Token contract address to match.&quot;&quot;&quot;</span>

    <span class="n">symbol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Token symbol to match.&quot;&quot;&quot;</span>

    <span class="n">log_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log index within the transaction receipt to match.&quot;&quot;&quot;</span>

    <span class="n">func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SortFunction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom matching function that takes a `TreasuryTx` and returns a bool or an awaitable that returns a bool.&quot;&quot;&quot;</span>

    <span class="c1"># __instances__: ClassVar[List[Self]] = []</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate inputs, checksum addresses, and register the rule.</span>

<span class="sd">        - Ensures no duplicate rule exists for the same `txgroup`.</span>
<span class="sd">        - Converts address fields to checksummed format.</span>
<span class="sd">        - Determines which attributes will be used for direct matching.</span>
<span class="sd">        - Validates that exactly one of attribute-based or function-based matching is provided.</span>
<span class="sd">        - Registers the instance in :attr:`SORT_RULES` and :data:`_match_all`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span> <span class="ow">in</span> <span class="n">_match_all</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;there is already a matcher defined for txgroup </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># ensure addresses are checksummed if applicable</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;from_address&quot;</span><span class="p">,</span> <span class="s2">&quot;to_address&quot;</span><span class="p">,</span> <span class="s2">&quot;token_address&quot;</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">checksummed</span> <span class="o">=</span> <span class="n">EthAddress</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="c1"># NOTE: we must use object.__setattr__ to modify a frozen dataclass instance</span>
                <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">checksummed</span><span class="p">)</span>

        <span class="c1"># define matchers used for this instance</span>
        <span class="n">matchers</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">_MATCHING_ATTRS</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">_match_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span><span class="p">]</span> <span class="o">=</span> <span class="n">matchers</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">matchers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You must specify attributes for matching or pass in a custom matching function, not both.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">matchers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You must specify attributes for matching or pass in a custom matching function.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;func must be callable. You passed </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># append new instance to instances classvar</span>
        <span class="c1"># TODO: fix dataclass ClassVar handling in mypyc and reenable</span>
        <span class="c1"># self.__instances__.append(self)</span>

        <span class="c1"># append new instance under its class key</span>
        <span class="n">SORT_RULES</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">txgroup_dbid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TxGroupDbid</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the database ID for this rule&#39;s `txgroup`.</span>

<span class="sd">        Splits the `txgroup` string on &#39;:&#39; and resolves or creates the hierarchical</span>
<span class="sd">        `TxGroup` entries in the database, returning the final group ID.</span>

<span class="sd">        See Also:</span>
<span class="sd">            :class:`~dao_treasury.db.TxGroup`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">dao_treasury.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">TxGroup</span>

        <span class="n">txgroup</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
            <span class="n">txgroup</span> <span class="o">=</span> <span class="n">TxGroup</span><span class="o">.</span><span class="n">get_dbid</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">txgroup</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">txgroup</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span> <span class="s2">&quot;TreasuryTx&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if the given transaction matches this rule.</span>

<span class="sd">        Args:</span>
<span class="sd">            tx: A `TreasuryTx` entity to test against this rule.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the transaction matches the rule criteria; otherwise False.</span>

<span class="sd">        Examples:</span>
<span class="sd">            # match by symbol and recipient</span>
<span class="sd">            &gt;&gt;&gt; rule = _SortRule(txgroup=&#39;Foo&#39;, symbol=&#39;DAI&#39;, to_address=&#39;0xabc...&#39;)</span>
<span class="sd">            &gt;&gt;&gt; await rule.match(tx)  # where tx.symbol == &#39;DAI&#39; and tx.to_address == &#39;0xabc...&#39;</span>
<span class="sd">            True</span>

<span class="sd">        See Also:</span>
<span class="sd">            :attr:`_match_all`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">matchers</span> <span class="o">:=</span> <span class="n">_match_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">matcher</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matcher</span><span class="p">)</span> <span class="k">for</span> <span class="n">matcher</span> <span class="ow">in</span> <span class="n">matchers</span>
            <span class="p">)</span>

        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>  <span class="c1"># type: ignore [misc]</span>
        <span class="k">return</span> <span class="n">match</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="k">else</span> <span class="k">await</span> <span class="n">match</span>


<span class="nd">@mypyc_attr</span><span class="p">(</span><span class="n">native_class</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_InboundSortRule</span><span class="p">(</span><span class="n">_SortRule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sort rule that applies only to inbound transactions (to the DAO&#39;s wallet).</span>

<span class="sd">    Checks that the transaction&#39;s `to_address` belongs to a known `TreasuryWallet`</span>
<span class="sd">    before applying the base matching logic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span> <span class="s2">&quot;TreasuryTx&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">tx</span><span class="o">.</span><span class="n">to_address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">TreasuryWallet</span><span class="o">.</span><span class="n">check_membership</span><span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">to_address</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">tx</span><span class="o">.</span><span class="n">block</span><span class="p">)</span>
            <span class="ow">and</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
        <span class="p">)</span>


<span class="nd">@mypyc_attr</span><span class="p">(</span><span class="n">native_class</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_OutboundSortRule</span><span class="p">(</span><span class="n">_SortRule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sort rule that applies only to outbound transactions (from the DAO&#39;s wallet).</span>

<span class="sd">    Checks that the transaction&#39;s `from_address` belongs to a known `TreasuryWallet`</span>
<span class="sd">    before applying the base matching logic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span> <span class="s2">&quot;TreasuryTx&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TreasuryWallet</span><span class="o">.</span><span class="n">check_membership</span><span class="p">(</span>
            <span class="n">tx</span><span class="o">.</span><span class="n">from_address</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">tx</span><span class="o">.</span><span class="n">block</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>


<div class="viewcode-block" id="RevenueSortRule">
<a class="viewcode-back" href="../../../source/dao_treasury.sorting.html#dao_treasury.RevenueSortRule">[docs]</a>
<span class="nd">@mypyc_attr</span><span class="p">(</span><span class="n">native_class</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RevenueSortRule</span><span class="p">(</span><span class="n">_InboundSortRule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rule to categorize inbound transactions as revenue.</span>

<span class="sd">    Prepends &#39;Revenue:&#39; to the `txgroup` name before registration.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; RevenueSortRule(txgroup=&#39;Sale&#39;, to_address=&#39;0xabc...&#39;, symbol=&#39;DAI&#39;)</span>
<span class="sd">        # results in a rule with txgroup &#39;Revenue:Sale&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepends `self.txgroup` with &#39;Revenue:&#39;.&quot;&quot;&quot;</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;txgroup&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Revenue:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span></div>



<div class="viewcode-block" id="CostOfRevenueSortRule">
<a class="viewcode-back" href="../../../source/dao_treasury.sorting.html#dao_treasury.CostOfRevenueSortRule">[docs]</a>
<span class="nd">@mypyc_attr</span><span class="p">(</span><span class="n">native_class</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CostOfRevenueSortRule</span><span class="p">(</span><span class="n">_OutboundSortRule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rule to categorize outbound transactions as cost of revenue.</span>

<span class="sd">    Prepends &#39;Cost of Revenue:&#39; to the `txgroup` name before registration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepends `self.txgroup` with &#39;Cost of Revenue:&#39;.&quot;&quot;&quot;</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;txgroup&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Cost of Revenue:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span></div>



<div class="viewcode-block" id="ExpenseSortRule">
<a class="viewcode-back" href="../../../source/dao_treasury.sorting.html#dao_treasury.ExpenseSortRule">[docs]</a>
<span class="nd">@mypyc_attr</span><span class="p">(</span><span class="n">native_class</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ExpenseSortRule</span><span class="p">(</span><span class="n">_OutboundSortRule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rule to categorize outbound transactions as expenses.</span>

<span class="sd">    Prepends &#39;Expenses:&#39; to the `txgroup` name before registration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepends `self.txgroup` with &#39;Expenses:&#39;.&quot;&quot;&quot;</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;txgroup&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Expenses:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span></div>



<div class="viewcode-block" id="OtherIncomeSortRule">
<a class="viewcode-back" href="../../../source/dao_treasury.sorting.html#dao_treasury.OtherIncomeSortRule">[docs]</a>
<span class="nd">@mypyc_attr</span><span class="p">(</span><span class="n">native_class</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OtherIncomeSortRule</span><span class="p">(</span><span class="n">_InboundSortRule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rule to categorize inbound transactions as other income.</span>

<span class="sd">    Prepends &#39;Other Income:&#39; to the `txgroup` name before registration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepends `self.txgroup` with &#39;Other Income:&#39;.&quot;&quot;&quot;</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;txgroup&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Other Income:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span></div>



<div class="viewcode-block" id="OtherExpenseSortRule">
<a class="viewcode-back" href="../../../source/dao_treasury.sorting.html#dao_treasury.OtherExpenseSortRule">[docs]</a>
<span class="nd">@mypyc_attr</span><span class="p">(</span><span class="n">native_class</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OtherExpenseSortRule</span><span class="p">(</span><span class="n">_OutboundSortRule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rule to categorize outbound transactions as other expenses.</span>

<span class="sd">    Prepends &#39;Other Expenses:&#39; to the `txgroup` name before registration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepends `self.txgroup` with &#39;Other Expenses:&#39;.&quot;&quot;&quot;</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;txgroup&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Other Expenses:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span></div>



<div class="viewcode-block" id="IgnoreSortRule">
<a class="viewcode-back" href="../../../source/dao_treasury.sorting.html#dao_treasury.IgnoreSortRule">[docs]</a>
<span class="nd">@mypyc_attr</span><span class="p">(</span><span class="n">native_class</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IgnoreSortRule</span><span class="p">(</span><span class="n">_SortRule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rule to ignore certain transactions.</span>

<span class="sd">    Prepends &#39;Ignore:&#39; to the `txgroup` name before registration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepends `self.txgroup` with &#39;Ignore:&#39;.&quot;&quot;&quot;</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;txgroup&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Ignore:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">txgroup</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span></div>



<span class="n">TRule</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span>
    <span class="s2">&quot;TRule&quot;</span><span class="p">,</span>
    <span class="n">RevenueSortRule</span><span class="p">,</span>
    <span class="n">CostOfRevenueSortRule</span><span class="p">,</span>
    <span class="n">ExpenseSortRule</span><span class="p">,</span>
    <span class="n">OtherIncomeSortRule</span><span class="p">,</span>
    <span class="n">OtherExpenseSortRule</span><span class="p">,</span>
    <span class="n">IgnoreSortRule</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, BobTheBuidler.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>